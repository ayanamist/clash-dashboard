import{j as e,c as w,r as m,p as Se,E as He,a as Oe,b as J,d as re,u as ee,e as ke,f as T,g as ze,h as Ue,i as K,R as Be,k as ot,l as je,s as at,m as lt,n as te,o as ct,q as le,t as it,v as rt,w as dt,x as ut,y as mt,z as Re,A as ht,B as ft,C as xt,D as pt,F as gt,G as yt,N as vt,O as wt,H as jt,I as ve,J as Nt,K as bt,L as Ct}from"./vendor-90c40d3a.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))o(a);new MutationObserver(a=>{for(const l of a)if(l.type==="childList")for(const c of l.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&o(c)}).observe(document,{childList:!0,subtree:!0});function n(a){const l={};return a.integrity&&(l.integrity=a.integrity),a.referrerPolicy&&(l.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?l.credentials="include":a.crossOrigin==="anonymous"?l.credentials="omit":l.credentials="same-origin",l}function o(a){if(a.ep)return;a.ep=!0;const l=n(a);fetch(a.href,l)}})();function Z(){return navigator.userAgent==="ClashX Runtime"}let $=null;class Pt{constructor(t){this.callbacksMap=new Map,this.initBridge(()=>{t()})}initBridge(t){if(!Z())return t==null?void 0:t();window.addEventListener("message",n=>{const o=n.data;if((o==null?void 0:o.id)==null)return;const a=this.callbacksMap.get(o.id);a==null||a(o.data),this.callbacksMap.delete(o.id)}),t==null||t()}async callHandler(t,n){var l;const o=Date.now().toString(),a={id:o,data:n,name:t};return(l=window.webkit)==null||l.messageHandlers.jsBridge.postMessage(a),await new Promise(c=>{var i;this.callbacksMap.set(o,r=>{c(r)}),(i=window.webkit)==null||i.messageHandlers.jsBridge.postMessage(a)})}async ping(){return await this.callHandler("ping")}async readConfigString(){return await this.callHandler("readConfigString")}async getPasteboard(){return await this.callHandler("getPasteboard")}async getAPIInfo(){return await this.callHandler("apiInfo")}async setPasteboard(t){return await this.callHandler("setPasteboard",t)}async writeConfigWithString(t){return await this.callHandler("writeConfigWithString",t)}async setSystemProxy(t){return await this.callHandler("setSystemProxy",t)}async getStartAtLogin(){return await this.callHandler("getStartAtLogin")}async getProxyDelay(t){return await this.callHandler("speedTest",t)}async setStartAtLogin(t){return await this.callHandler("setStartAtLogin",t)}async isSystemProxySet(){return await this.callHandler("isSystemProxySet")}}function St(s){if($!=null){s();return}$=new Pt(s)}function V(s){const{title:t,children:n,className:o,style:a}=s;return e.jsxs("header",{className:w("header",o),style:a,children:[e.jsx("h1",{className:"md:text-xl",children:t}),e.jsx("div",{className:"flex flex-auto items-center justify-end",children:n})]})}function R(s){const{type:t,size:n=14,className:o,style:a}=s,l=w("clash-iconfont",`icon-${t}`,o),c={fontSize:n,...a},i={...s,className:l,style:c};return e.jsx("i",{...i})}function M(){}function kt(s,t){const n=[],o=[];for(const a of s)t(a)?n.push(a):o.push(a);return[n,o]}function U(s){const t=["B","KiB","MiB","GiB","TiB"],n=Math.floor(Math.log(s||1)/Math.log(1024));return`${(Math.floor(s/Math.pow(1024,n)*100)/100).toFixed(2)} ${(t==null?void 0:t[n])??""}`}function $t(s){return s.replace(/.*[/\\]/,"")}function we(s){const{className:t,checked:n=!1,disabled:o=!1,onChange:a=M}=s,l=w("switch",{checked:n,disabled:o},t);function c(){o||a(!n)}return e.jsx("div",{className:l,onClick:c,children:e.jsx(R,{className:"switch-icon font-bold",type:"check",size:20})})}const B=m.forwardRef((s,t)=>{const{className:n,style:o,children:a}=s;return e.jsx("div",{className:w("card",n),style:o,ref:t,children:a})});function Me(s){const{options:t,value:n,onSelect:o}=s;return e.jsx("div",{className:"button-select",children:t.map(a=>e.jsx("button",{value:a.value,className:w("button-select-options",{actived:n===a.value}),onClick:()=>o==null?void 0:o(a.value),children:a.label},a.value))})}const Et={SideBar:{Proxies:"Proxies",Overview:"Overview",Logs:"Logs",Rules:"Rules",Settings:"Setting",Connections:"Connections",Version:"Version"},Settings:{title:"Settings",labels:{startAtLogin:"Start at login",language:"language",setAsSystemProxy:"Set as system proxy",allowConnectFromLan:"Allow connect from Lan",proxyMode:"Mode",socks5ProxyPort:"Socks5 proxy port",httpProxyPort:"HTTP proxy port",mixedProxyPort:"Mixed proxy port",externalController:"External controller",reloadConfig:"Reload config"},values:{cn:"中文",en:"English",global:"Global",rules:"Rules",direct:"Direct",script:"Script"},versionString:"Current ClashX is the latest version：{{version}}",checkUpdate:"Check Update",externalControllerSetting:{title:"External Controller",note:"Please note that modifying this configuration will only configure Dashboard. Will not modify your Clash configuration file. Please make sure that the external controller address matches the address in the Clash configuration file, otherwise, Dashboard will not be able to connect to Clash.",host:"Host",port:"Port",secret:"Secret",addText:"Add",deleteText:"Delete",deleteErrorText:"Host not found"},messages:{reloadOk:"Reload OK",reloadErr:"Error:"}},Logs:{title:"Logs",levelLabel:"Log level"},Rules:{title:"Rules",providerTitle:"Providers",providerUpdateTime:"Last updated at",ruleCount:"Rule count"},Connections:{title:"Connections",keepClosed:"Keep closed connections",total:{text:"total",upload:"upload",download:"download"},closeAll:{title:"Warning",content:"This would close all connections"},filter:{all:"All"},columns:{host:"Host",network:"Network",type:"Type",chains:"Chains",process:"Process",rule:"Rule",time:"Time",speed:"Speed",upload:"Upload",download:"Download",sourceIP:"Source IP"},info:{title:"Connection",id:"ID",host:"Host",hostEmpty:"Empty",dstIP:"IP",dstIPEmpty:"Empty",srcIP:"Source",upload:"Up",download:"Down",network:"Network",process:"Process",processPath:"Path",inbound:"Inbound",rule:"Rule",chains:"Chains",status:"Status",opening:"Open",closed:"Closed",closeConnection:"Close",time:"Start From"}},Proxies:{title:"Proxies",editDialog:{title:"Edit Proxy",color:"Color",name:"Name",type:"Type",server:"Server",port:"Port",password:"Password",cipher:"Cipher",obfs:"Obfs","obfs-host":"Obfs-host",uuid:"UUID",alterId:"AlterId",tls:"TLS"},groupTitle:"Policy Group",providerTitle:"Providers",providerUpdateTime:"Last updated at",expandText:"Expand",collapseText:"Collapse",speedTestText:"Speed Test",breakConnectionsText:"Close connections which include the group"},Modal:{ok:"Ok",cancel:"Cancel"}},Lt={SideBar:{Proxies:"代理",Overview:"总览",Logs:"日志",Rules:"规则",Settings:"设置",Connections:"连接",Version:"版本"},Settings:{title:"设置",labels:{startAtLogin:"开机时启动",language:"语言",setAsSystemProxy:"设置为系统代理",allowConnectFromLan:"允许来自局域网的连接",proxyMode:"代理模式",socks5ProxyPort:"Socks5 代理端口",httpProxyPort:"HTTP 代理端口",mixedProxyPort:"混合代理端口",externalController:"外部控制设置",reloadConfig:"重新加载配置"},values:{cn:"中文",en:"English",global:"全局",rules:"规则",direct:"直连",script:"脚本"},versionString:"当前 ClashX 已是最新版本：{{version}}",checkUpdate:"检查更新",externalControllerSetting:{title:"编辑外部控制设置",note:"请注意，修改该配置项并不会修改你的 Clash 配置文件，请确认修改后的外部控制地址和 Clash 配置文件内的地址一致，否则会导致 Dashboard 无法连接。",host:"Host",port:"端口",secret:"密钥",addText:"添 加",deleteText:"删 除",deleteErrorText:"没有找到该 Host"},messages:{reloadOk:"重新加载配置成功",reloadErr:"错误："}},Logs:{title:"日志",levelLabel:"日志等级"},Rules:{title:"规则",providerTitle:"规则集",providerUpdateTime:"最后更新于",ruleCount:"规则条数"},Connections:{title:"连接",keepClosed:"保留关闭连接",total:{text:"总量",upload:"上传",download:"下载"},closeAll:{title:"警告",content:"将会关闭所有连接"},filter:{all:"全部"},columns:{host:"域名",network:"网络",process:"进程",type:"类型",chains:"节点链",rule:"规则",time:"连接时间",speed:"速率",upload:"上传",download:"下载",sourceIP:"来源 IP"},info:{title:"连接信息",id:"ID",host:"域名",hostEmpty:"空",dstIP:"IP",dstIPEmpty:"空",srcIP:"来源",upload:"上传",download:"下载",network:"网络",process:"进程",processPath:"路径",inbound:"入口",rule:"规则",chains:"代理",status:"状态",opening:"连接中",closed:"已关闭",closeConnection:"关闭连接",time:"连接开始"}},Proxies:{title:"代理",editDialog:{title:"编辑代理",color:"颜色",name:"名字",type:"类型",server:"服务器",port:"端口",password:"密码",cipher:"加密方式",obfs:"Obfs","obfs-host":"Obfs-host",uuid:"UUID",alterId:"AlterId",tls:"TLS"},groupTitle:"策略组",providerTitle:"代理集",providerUpdateTime:"最后更新于",expandText:"展开",collapseText:"收起",speedTestText:"测速",breakConnectionsText:"切换时打断包含策略组的连接"},Modal:{ok:"确 定",cancel:"取 消"}},Fe={en_US:Et,zh_CN:Lt},It=Object.keys(Fe);function Tt(){for(const s of window.navigator.languages){if(s.includes("zh"))return"zh_CN";if(s.includes("us"))return"en_US"}return"en_US"}function $e(s){return m.useMemo(()=>{function n(o,a){if(typeof o=="string")s(l=>{const c=o,i=a;l[c]=i});else if(typeof o=="function"){const l=o;s(c=>l(c))}else typeof o=="object"&&s(l=>Se(l,c=>{const i=o;for(const r of Object.keys(i)){const u=r;c[u]=i[u]}}))}return n},[s])}class _e{constructor(t){this.EE=new He,this.innerBuffer=[],this.url="",this.connection=null,this.config=Object.assign({bufferLength:0,retryInterval:5e3},t)}connectWebsocket(){if(!this.url)return;const t=new URL(this.url);this.connection=new WebSocket(t.toString()),this.connection.addEventListener("message",n=>{const o=JSON.parse(n.data);this.EE.emit("data",[o]),this.config.bufferLength>0&&(this.innerBuffer.push(o),this.innerBuffer.length>this.config.bufferLength&&this.innerBuffer.splice(0,this.innerBuffer.length-this.config.bufferLength))}),this.connection.addEventListener("error",n=>{var o;this.EE.emit("error",n),(o=this.connection)==null||o.close(),setTimeout(this.connectWebsocket,this.config.retryInterval)})}connect(t){var n;this.url===t&&this.connection||(this.url=t,(n=this.connection)==null||n.close(),this.connectWebsocket())}subscribe(t,n){this.EE.addListener(t,n)}unsubscribe(t,n){this.EE.removeListener(t,n)}buffer(){return this.innerBuffer.slice()}destory(){var t;this.EE.removeAllListeners(),(t=this.connection)==null||t.close(),this.connection=null}}const G="(?:25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]\\d|\\d)(?:\\.(?:25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]\\d|\\d)){3}",S="[a-fA-F\\d]{1,4}",Rt=`
(?:
(?:${S}:){7}(?:${S}|:)|                                    // 1:2:3:4:5:6:7::  1:2:3:4:5:6:7:8
(?:${S}:){6}(?:${G}|:${S}|:)|                             // 1:2:3:4:5:6::    1:2:3:4:5:6::8   1:2:3:4:5:6::8  1:2:3:4:5:6::1.2.3.4
(?:${S}:){5}(?::${G}|(?::${S}){1,2}|:)|                   // 1:2:3:4:5::      1:2:3:4:5::7:8   1:2:3:4:5::8    1:2:3:4:5::7:1.2.3.4
(?:${S}:){4}(?:(?::${S}){0,1}:${G}|(?::${S}){1,3}|:)| // 1:2:3:4::        1:2:3:4::6:7:8   1:2:3:4::8      1:2:3:4::6:7:1.2.3.4
(?:${S}:){3}(?:(?::${S}){0,2}:${G}|(?::${S}){1,4}|:)| // 1:2:3::          1:2:3::5:6:7:8   1:2:3::8        1:2:3::5:6:7:1.2.3.4
(?:${S}:){2}(?:(?::${S}){0,3}:${G}|(?::${S}){1,5}|:)| // 1:2::            1:2::4:5:6:7:8   1:2::8          1:2::4:5:6:7:1.2.3.4
(?:${S}:){1}(?:(?::${S}){0,4}:${G}|(?::${S}){1,6}|:)| // 1::              1::3:4:5:6:7:8   1::8            1::3:4:5:6:7:1.2.3.4
(?::(?:(?::${S}){0,5}:${G}|(?::${S}){1,7}|:))             // ::2:3:4:5:6:7:8  ::2:3:4:5:6:7:8  ::8             ::1.2.3.4
)(?:%[0-9a-zA-Z]{1,})?                                             // %eth0            %1
`.replace(/\s*\/\/.*$/gm,"").replace(/\n/g,"").trim(),Mt=new RegExp(`(?:^${G}$)|(?:^${Rt}$)`);function Dt(s){return Mt.test(s)}class At{constructor(t,n){this.axiosClient=Oe.create({baseURL:t,headers:n?{Authorization:`Bearer ${n}`}:{}})}async getConfig(){return await this.axiosClient.get("configs")}async updateConfig(t){return await this.axiosClient.patch("configs",t)}async reloadConfig(){return await this.axiosClient.put("configs",{})}async getRules(){return await this.axiosClient.get("rules")}async getProxyProviders(){const t=await this.axiosClient.get("providers/proxies",{validateStatus(n){return n>=200&&n<300||n===404}});return t.status===404&&(t.data={providers:{}}),t}async getRuleProviders(){return await this.axiosClient.get("providers/rules")}async updateProvider(t){return await this.axiosClient.put(`providers/proxies/${encodeURIComponent(t)}`)}async updateRuleProvider(t){return await this.axiosClient.put(`providers/rules/${encodeURIComponent(t)}`)}async healthCheckProvider(t){return await this.axiosClient.get(`providers/proxies/${encodeURIComponent(t)}/healthcheck`)}async getProxies(){return await this.axiosClient.get("proxies")}async getProxy(t){return await this.axiosClient.get(`proxies/${encodeURIComponent(t)}`)}async getVersion(){return await this.axiosClient.get("version")}async getProxyDelay(t){return await this.axiosClient.get(`proxies/${encodeURIComponent(t)}/delay`,{params:{timeout:5e3,url:localStorage.getItem("probeUrl")||"https://i.ytimg.com/generate_204"}})}async closeAllConnections(){return await this.axiosClient.delete("connections")}async closeConnection(t){return await this.axiosClient.delete(`connections/${t}`)}async getConnections(){return await this.axiosClient.get("connections")}async changeProxySelected(t,n){return await this.axiosClient.put(`proxies/${encodeURIComponent(t)}`,{name:n})}}const Ht=J(async()=>{if(!Z())return null;const s=await $.getAPIInfo();return{hostname:s.host,port:s.port,secret:s.secret,protocol:"http:"}});function Ot(){if(!Dt(location.hostname))return null;if(location.port!=="")return JSON.stringify([{hostname:location.hostname,port:+location.port,secret:""}]);const s=location.protocol==="https:"?443:80;return JSON.stringify([{hostname:location.hostname,port:s,secret:""}])}const zt=localStorage.getItem("externalControllers")??Ot()??'[{ "hostname": "127.0.0.1", "port": 7890, "secret": "" }]',Ut=localStorage.getItem("externalControllerIndex")??"0",Ee=re("externalControllers",JSON.parse(zt)),Le=re("externalControllerIndex",parseInt(Ut));function se(){var x,y,v,d;const s=ee(Ht),t=ke(),n=ee(Le),o=ee(Ee);if(s!=null)return s;let a;{const p=document.querySelector('meta[name="external-controller"]');((x=p==null?void 0:p.content)==null?void 0:x.match(/^https?:/))!=null&&(a=new URL(p.content))}const l=new URLSearchParams(t.search),c=l.get("host")??((y=o==null?void 0:o[n])==null?void 0:y.hostname)??(a==null?void 0:a.hostname)??"127.0.0.1",i=l.get("port")??((v=o==null?void 0:o[n])==null?void 0:v.port)??(a==null?void 0:a.port)??"9090",r=l.get("secret")??((d=o==null?void 0:o[n])==null?void 0:d.secret)??(a==null?void 0:a.username)??"",u=l.get("protocol")??c==="127.0.0.1"?"http:":(a==null?void 0:a.protocol)??window.location.protocol;return{hostname:c,port:i,secret:r,protocol:u}}const Bt=J({key:"",instance:null});function D(){const{hostname:s,port:t,secret:n,protocol:o}=se(),[a,l]=T(Bt),c=`${o}//${s}:${t}?secret=${n}`;if(a.key===c)return a.instance;const i=new At(`${o}//${s}:${t}`,n);return l({key:c,instance:i}),i}const Ie=J(!0),Ft=re("language",void 0);function E(){const[s,t]=T(Ft),n=m.useMemo(()=>s??Tt(),[s]),o=m.useCallback(function(a){function l(c){const i=Fe[n][a],r=at(c);return lt(i,r,"")}return{t:l}},[n]);return{lang:n,locales:It,setLang:t,translation:o}}const Ge=J({version:"",premium:!1});function Ve(){const[s,t]=T(Ge),n=D(),o=Ue(Ie);return K([n],async function(){const a=await Be.fromPromise(n.getVersion(),l=>l);o(a.isOk()),t(a.isErr()?{version:"",premium:!1}:{version:a.value.data.version,premium:!!a.value.data.premium})}),s}function We(){const[{premium:s}]=T(Ge),t=D(),{data:n,mutate:o}=K(["/providers/rule",t,s],async()=>{if(!s)return[];const a=await t.getRuleProviders();return Object.keys(a.data.providers).map(l=>a.data.providers[l])});return{providers:n??[],update:o}}const _t=re("profile",{breakConnections:!1,logLevel:""});function de(){const[s,t]=T(_t),n=m.useCallback(o=>{t(Se(s,o))},[s,t]);return{data:s,set:$e(n)}}const Je=J([]);function Ke(){const[s,t]=T(Je),n=D(),{data:o,mutate:a}=K(["/providers/proxy",n],async()=>{const l=await n.getProxyProviders();return Object.keys(l.data.providers).map(c=>l.data.providers[c]).filter(c=>c.name!=="default").filter(c=>c.vehicleType!=="Compatible")});return m.useEffect(()=>{t(o??[])},[o,t]),{providers:s,update:a}}function ue(){const s=D(),{data:t,mutate:n}=K(["/config",s],async()=>{const a=(await s.getConfig()).data;return{port:a.port,socksPort:a["socks-port"],mixedPort:a["mixed-port"]??0,redirPort:a["redir-port"],mode:a.mode.toLowerCase(),logLevel:a["log-level"],allowLan:a["allow-lan"]}});return{general:t??{},update:n}}const Xe=ze({proxies:[],groups:[],global:{name:"GLOBAL",type:"Selector",now:"",history:[],all:[]}});function me(){const[s,t]=T(Xe),n=$e(t),o=D(),{mutate:a}=K(["/proxies",o],async()=>{const c=await o.getProxies(),i=c.data.proxies.GLOBAL;i.name="GLOBAL";const r=new Set(["Selector","URLTest","Fallback","LoadBalance"]),u=new Set(["DIRECT","REJECT","PASS","GLOBAL"]),x=i.all.filter(d=>!u.has(d)).map(d=>({...c.data.proxies[d],name:d})),[y,v]=kt(x,d=>!r.has(d.type));n({proxies:y,groups:v,global:i})}),l=m.useCallback((c,i)=>{n(r=>{c==="GLOBAL"&&(r.global.now=i);for(const u of r.groups)u.name===c&&(u.now=i)})},[n]);return{proxies:s.proxies,groups:s.groups,global:s.global,update:a,markProxySelected:l,set:n}}const Gt=J(s=>{const t=s(Xe),n=s(Je),o=new Map;for(const a of t.proxies)o.set(a.name,a);for(const a of n)for(const l of a.proxies)o.set(l.name,l);return o});function Ye(){const{data:s,mutate:t}=K("/clashx",async()=>{if(!Z())return{isClashX:!1,startAtLogin:!1,systemProxy:!1};const n=await($==null?void 0:$.getStartAtLogin())??!1,o=await($==null?void 0:$.isSystemProxySet())??!1;return{startAtLogin:n,systemProxy:o,isClashX:!0}});return{data:s,update:t}}const Vt=ze([]);function Wt(){const[s,t]=T(Vt),n=$e(t),o=D();async function a(){const l=await o.getRules();n(l.data.rules)}return{rules:s,update:a}}const Jt=J(new _e({bufferLength:200}));function qe(){const s=se(),{general:t}=ue(),{data:{logLevel:n}}=de(),o=ee(Jt),a=n||t.logLevel,l=ot(`${s.protocol}//${s.hostname}:${s.port}/logs?level=${a}&secret=${encodeURIComponent(s.secret)}`),c=je(s);return m.useEffect(()=>{if(a){const i=c.current,u=`${i.protocol==="http:"?"ws:":"wss:"}//${i.hostname}:${i.port}/logs?level=${a}&token=${encodeURIComponent(i.secret)}`;o.connect(u)}},[c,o,a,l]),o}function Kt(){const s=se(),t=m.useRef(new _e({bufferLength:200})),o=`${s.protocol==="http:"?"ws:":"wss:"}//${s.hostname}:${s.port}/connections?token=${encodeURIComponent(s.secret)}`;return m.useEffect(()=>{t.current.connect(o)},[o]),t.current}function Xt(s){const{className:t,data:n,onClick:o,select:a,canClick:l,errSet:c,rowHeight:i}=s,{translation:r}=E(),{t:u}=r("Proxies"),[x,y]=m.useState(!1),[v,d]=m.useState(!1),p=m.useRef(null);m.useLayoutEffect(()=>{var N;d((((N=p==null?void 0:p.current)==null?void 0:N.offsetHeight)??0)>30)},[]);const P=x?"auto":i,g=l?o:M;function b(){y(!x)}const k=n.map(N=>{const L=w({"tags-selected":a===N,"cursor-pointer":l,error:c==null?void 0:c.has(N)});return e.jsx("li",{className:L,onClick:()=>g(N),children:N},N)});return e.jsxs("div",{className:w("flex items-start overflow-y-hidden",t),style:{height:P},children:[e.jsx("ul",{ref:p,className:w("tags",{expand:x}),children:k}),v&&e.jsx("span",{className:"h-7 cursor-pointer select-none px-5 leading-7",onClick:b,children:u(x?"collapseText":"expandText")})]})}function Y(s){const{className:t,style:n,value:o="",align:a="center",inside:l=!1,autoFocus:c=!1,type:i="text",disabled:r=!1,onChange:u=M,onBlur:x=M,onEnter:y=M}=s,v=w("input",`text-${a}`,{"focus:shadow-none":l},t);function d(p){p.code==="Enter"&&y(p)}return e.jsx("input",{disabled:r,className:v,style:n,value:o,autoFocus:c,type:i,onChange:p=>u(p.target.value,p),onBlur:x,onKeyDown:d})}function Ze(s){const{value:t,options:n,onSelect:o,disabled:a,className:l,style:c}=s,i=m.useRef(document.createElement("div")),r=m.useRef(null),[u,x]=m.useState(!1),[y,v]=m.useState({});m.useLayoutEffect(()=>{const g=i.current;return document.body.appendChild(g),()=>{document.body.removeChild(g)}},[]);function d(){if(!a){if(!u){const g=r.current.getBoundingClientRect();v({top:Math.floor(g.top+g.height)+6,left:Math.floor(g.left)-10})}x(!u)}}const p=m.useMemo(()=>n.find(g=>g.value===t),[t,n]),P=e.jsx("div",{className:w("select-list",{"select-list-show":u}),style:y,children:e.jsx("ul",{className:"list",children:n.map(g=>e.jsx(Yt,{className:w({selected:g.value===t}),onClick:b=>{o==null||o(g.value,b),x(!1)},disabled:g.disabled,value:g.value,children:g.label},g.key??g.value))})});return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:w("select",{disabled:a},l),style:c,ref:r,onClick:d,children:[e.jsx("span",{className:"select-none",children:p==null?void 0:p.label}),e.jsx(R,{type:"triangle-down"})]}),te.createPortal(P,i.current)]})}function Yt(s){const{className:t,style:n,disabled:o=!1,children:a,onClick:l=M}=s,c=w("option",{disabled:o},t);return e.jsx("li",{className:c,style:n,onClick:l,children:a})}function Qe(s){const{show:t=!0,title:n="Modal",size:o="small",footer:a=!0,onOk:l=M,onClose:c=M,bodyClassName:i,bodyStyle:r,className:u,footerExtra:x,style:y,children:v}=s,{translation:d}=E(),{t:p}=d("Modal"),P=m.useRef(document.createElement("div")),g=m.useRef(null);m.useLayoutEffect(()=>{const N=P.current;return document.body.appendChild(N),()=>{document.body.removeChild(N)}},[]);function b(N){N.target===g.current&&c()}const k=e.jsx("div",{className:w("modal-mask",{"modal-show":t}),ref:g,onMouseDown:b,children:e.jsxs("div",{className:w("modal",`modal-${o}`,u),style:y,children:[e.jsx("div",{className:"modal-title",children:n}),e.jsx("div",{className:w("modal-body",i),style:r,children:v}),a&&e.jsxs("div",{className:"flex items-center justify-between",children:[x,e.jsxs("div",{className:"flex flex-1 justify-end space-x-3",children:[e.jsx(q,{onClick:()=>c(),children:p("cancel")}),e.jsx(q,{type:"primary",onClick:()=>l(),children:p("ok")})]})]})]})});return te.createPortal(k,P.current)}const qt={success:"check",info:"info",warning:"info",error:"close"};function Zt(s){const{message:t="",type:n="info",inside:o=!1,children:a,className:l,style:c}=s,i=w("alert",`alert-${o?"note":"box"}-${n}`,l);return e.jsxs("div",{className:i,style:c,children:[e.jsx("span",{className:"alert-icon",children:e.jsx(R,{type:qt[n],size:26})}),t?e.jsx("p",{className:"alert-message",children:t}):e.jsx("div",{className:"alert-message",children:a})]})}function q(s){const{type:t="normal",onClick:n=M,children:o,className:a,style:l,disabled:c}=s,i=w("button",`button-${t}`,a,{"button-disabled":c});return e.jsx("button",{className:i,style:l,onClick:n,disabled:c,children:o})}function ce(s){const[t,n]=ct(s),o=m.useMemo(()=>{function a(l,c){typeof l=="string"?n(i=>{const r=l,u=c;i[r]=u}):typeof l=="function"?n(l):typeof l=="object"&&n(i=>{const r=l;for(const u of Object.keys(r)){const x=u;i[x]=r[x]}})}return a},[n]);return[t,o]}function Qt(s,t=0){if(s.length<2)throw new Error("List requires at least two elements");const[n,o]=m.useState(t);function a(){o((n+1)%s.length)}return{current:m.useMemo(()=>s[n],[s,n]),next:a}}function he(s=!1){const[t,n]=m.useState(s);function o(){n(!1)}function a(){n(!0)}return{visible:t,hide:o,show:a}}const es={info:"info",success:"check",warning:"info-o",error:"close"};function ts(s){const{removeComponent:t=M,onClose:n=M,icon:o=e.jsx(R,{type:"info",size:16}),content:a="",type:l="info",duration:c=1500}=s,{visible:i,show:r,hide:u}=he();return m.useEffect(()=>{window.setTimeout(()=>r(),0);const x=window.setTimeout(()=>{u(),n(),t()},c);return()=>window.clearTimeout(x)},[c,u,n,r]),e.jsxs("div",{className:w("message",`message-${l}`,{"message-show":i}),onTransitionEnd:()=>!i&&t(),children:[e.jsx("span",{className:"message-icon",children:o}),e.jsx("span",{className:"message-content",children:a})]})}function et(s){const t=document.createElement("div");document.body.appendChild(t);const n=()=>{te.unmountComponentAtNode(t)&&document.body.removeChild(t)},o=e.jsx(R,{type:es[s.type],size:16}),{type:a,content:l,duration:c,onClose:i}=s,r={icon:o,type:a,content:l,removeComponent:n,duration:c,onClose:i};te.render(e.jsx(ts,{...r}),t)}const ss=(s,t,n)=>et({type:"success",content:s,duration:t,onClose:n}),Ne=(s,t,n)=>et({type:"error",content:s,duration:t,onClose:n});function tt(s){const{className:t,checked:n=!1,onChange:o=M}=s,a=w("checkbox",{checked:n},t);function l(){o(!n)}return e.jsxs("div",{className:a,onClick:l,children:[e.jsx(R,{className:"checkbox-icon",type:"check",size:18}),e.jsx("div",{children:s.children})]})}function ie(s){const{color:t,className:n,style:o}=s,a=w("tag",n),l={color:t,...o},c={...s,className:a,style:l};return e.jsx("span",{...c,children:s.children})}function ns(s){const t=w("spinner",s.className);return e.jsxs("div",{className:t,children:[e.jsx("div",{className:"spinner-circle",children:e.jsx("div",{className:"spinner-inner"})}),e.jsx("div",{className:"spinner-circle",children:e.jsx("div",{className:"spinner-inner"})}),e.jsx("div",{className:"spinner-circle",children:e.jsx("div",{className:"spinner-inner"})}),e.jsx("div",{className:"spinner-circle",children:e.jsx("div",{className:"spinner-inner"})}),e.jsx("div",{className:"spinner-circle",children:e.jsx("div",{className:"spinner-inner"})})]})}function st(s){const t=w("loading","visible",s.className);return s.visible?e.jsx("div",{className:t,children:e.jsx(ns,{className:s.spinnerClassName})}):null}function os(s){var a;const t=m.useRef(document.createElement("div"));m.useLayoutEffect(()=>{const l=t.current;return document.body.appendChild(l),()=>{document.body.removeChild(l)}},[]);const n="absolute h-full right-0 transition-transform transform duration-100 pointer-events-auto",o=e.jsx("div",{className:w(s.className,"z-9999 pointer-events-none absolute inset-0"),children:e.jsx(B,{className:w(n,s.bodyClassName,{"translate-x-0":s.visible,"translate-x-full":!s.visible}),style:{width:s.width??400},children:s.children})});return te.createPortal(o,((a=s.containerRef)==null?void 0:a.current)??t.current)}le.extend(it);function Te(s,t){const n=t==="en_US"?"en":"zh-cn";return le(s).locale(n).from(le())}function as(s){const{translation:t}=E(),n=m.useMemo(()=>t("Connections").t,[t]),{className:o,style:a}=s,l=w("flex flex-wrap px-1",o);function c(i){var r;(r=s.onChange)==null||r.call(s,i)}return e.jsxs("div",{className:l,style:a,children:[e.jsx("div",{className:w("connections-devices-item mb-2 pt-2",{selected:s.selected===""}),onClick:()=>c(""),children:n("filter.all")}),s.devices.map(i=>e.jsxs("div",{className:w("connections-devices-item mb-2 pt-2",{selected:s.selected===i.label}),onClick:()=>c(i.label),children:[i.label," (",i.number,")"]},i.label))]})}function ls(s){var o,a,l,c,i,r,u,x,y,v,d;const{translation:t}=E(),n=m.useMemo(()=>t("Connections").t,[t]);return e.jsxs("div",{className:w(s.className,"flex flex-col overflow-y-auto text-sm"),children:[e.jsxs("div",{className:"my-3 flex",children:[e.jsx("span",{className:"w-20 font-bold",children:n("info.id")}),e.jsx("span",{className:"font-mono",children:s.connection.id})]}),e.jsxs("div",{className:"my-3 flex justify-between",children:[e.jsxs("div",{className:"flex flex-1",children:[e.jsx("span",{className:"w-20 font-bold",children:n("info.network")}),e.jsx("span",{className:"font-mono",children:(o=s.connection.metadata)==null?void 0:o.network})]}),e.jsxs("div",{className:"flex flex-1",children:[e.jsx("span",{className:"w-20 font-bold",children:n("info.inbound")}),e.jsx("span",{className:"font-mono",children:(a=s.connection.metadata)==null?void 0:a.type})]})]}),e.jsxs("div",{className:"my-3 flex",children:[e.jsx("span",{className:"w-20 font-bold",children:n("info.host")}),e.jsx("span",{className:"flex-1 break-all font-mono",children:(l=s.connection.metadata)!=null&&l.host?`${s.connection.metadata.host}:${(c=s.connection.metadata)==null?void 0:c.destinationPort}`:n("info.hostEmpty")})]}),e.jsxs("div",{className:"my-3 flex",children:[e.jsx("span",{className:"w-20 font-bold",children:n("info.dstIP")}),e.jsx("span",{className:"font-mono",children:(i=s.connection.metadata)!=null&&i.destinationIP?`${s.connection.metadata.destinationIP}:${(r=s.connection.metadata)==null?void 0:r.destinationPort}`:n("info.hostEmpty")})]}),e.jsxs("div",{className:"my-3 flex",children:[e.jsx("span",{className:"w-20 font-bold",children:n("info.srcIP")}),e.jsx("span",{className:"font-mono",children:`${(u=s.connection.metadata)==null?void 0:u.sourceIP}:${(x=s.connection.metadata)==null?void 0:x.sourcePort}`})]}),e.jsxs("div",{className:"my-3 flex",children:[e.jsx("span",{className:"w-20 font-bold",children:n("info.process")}),e.jsx("span",{className:"flex-1 break-all font-mono",children:(y=s.connection.metadata)!=null&&y.processPath?`${$t(s.connection.metadata.processPath)}`:n("info.hostEmpty")})]}),e.jsxs("div",{className:"my-3 flex",children:[e.jsx("span",{className:"w-20 font-bold",children:n("info.processPath")}),e.jsx("span",{className:"flex-1 break-all font-mono",children:(v=s.connection.metadata)!=null&&v.processPath?`${s.connection.metadata.processPath}`:n("info.hostEmpty")})]}),e.jsxs("div",{className:"my-3 flex",children:[e.jsx("span",{className:"w-20 font-bold",children:n("info.rule")}),e.jsx("span",{className:"font-mono",children:s.connection.rule&&`${s.connection.rule}${s.connection.rulePayload&&` :: ${s.connection.rulePayload}`}`})]}),e.jsxs("div",{className:"my-3 flex",children:[e.jsx("span",{className:"w-20 font-bold",children:n("info.chains")}),e.jsx("span",{className:"flex-1 break-all font-mono",children:(d=s.connection.chains)==null?void 0:d.slice().reverse().join(" / ")})]}),e.jsxs("div",{className:"my-3 flex justify-between",children:[e.jsxs("div",{className:"flex flex-1",children:[e.jsx("span",{className:"w-20 font-bold",children:n("info.upload")}),e.jsx("span",{className:"font-mono",children:U(s.connection.upload??0)})]}),e.jsxs("div",{className:"flex flex-1",children:[e.jsx("span",{className:"w-20 font-bold",children:n("info.download")}),e.jsx("span",{className:"font-mono",children:U(s.connection.download??0)})]})]}),e.jsxs("div",{className:"my-3 flex",children:[e.jsx("span",{className:"w-20 font-bold",children:n("info.status")}),e.jsx("span",{className:"font-mono",children:s.connection.completed?e.jsx("span",{className:"text-red",children:n("info.closed")}):e.jsx("span",{className:"text-green",children:n("info.opening")})})]}),e.jsxs("div",{className:"my-3 flex",children:[e.jsx("span",{className:"w-20 font-bold",children:n("info.time")}),e.jsx("span",{className:"font-mono",children:s.connection.start?new Intl.DateTimeFormat("zh-Hans",{dateStyle:"medium",timeStyle:"medium"}).format(new Date(s.connection.start)):""})]})]})}class cs{constructor(){this.connections=new Map,this.saveDisconnection=!1}appendToSet(t){var o;const n=t.reduce((a,l)=>a.set(l.id,l),new Map);for(const a of this.connections.keys())if(!n.has(a))if(!this.saveDisconnection)this.connections.delete(a);else{const l=this.connections.get(a);l!=null&&this.connections.set(a,Se(l,c=>{c.completed=!0,c.uploadSpeed=0,c.downloadSpeed=0}))}for(const a of n.keys()){if(!this.connections.has(a)){this.connections.set(a,{...n.get(a),uploadSpeed:0,downloadSpeed:0});continue}const l=this.connections.get(a),c=n.get(a);(o=this.connections)==null||o.set(a,{...c,uploadSpeed:c.upload-l.upload,downloadSpeed:c.download-l.download})}}toggleSave(){var t,n;if(this.saveDisconnection){this.saveDisconnection=!1;for(const o of this.connections.keys())(n=(t=this.connections)==null?void 0:t.get(o))!=null&&n.completed&&this.connections.delete(o)}else this.saveDisconnection=!0;return this.saveDisconnection}getConnections(){return[...this.connections.values()]}}function is(){const s=m.useMemo(()=>new cs,[]),t=m.useRef(!0),[n,o]=m.useState([]),[a,l]=m.useState(!1),c=m.useCallback(function(r){s.appendToSet(r),t.current&&o(s.getConnections()),t.current=!t.current},[s]),i=m.useCallback(function(){const r=s.toggleSave();l(r),r||o(s.getConnections()),t.current=!0},[s]);return{connections:n,feed:c,toggleSave:i,save:a}}const j={Host:"host",Network:"network",Type:"type",Chains:"chains",Rule:"rule",Speed:"speed",Upload:"upload",Download:"download",SourceIP:"sourceIP",Time:"time"},rs=new Set([j.Network,j.Type,j.Speed,j.Upload,j.Download,j.SourceIP,j.Time]);function ds(s,t){switch(!0){case(s===0&&t===0):return"-";case(s!==0&&t!==0):return`↑ ${U(s)}/s ↓ ${U(t)}/s`;case s!==0:return`↑ ${U(s)}/s`;default:return`↓ ${U(t)}/s`}}const z=ht();function us(){const{translation:s,lang:t}=E(),n=m.useMemo(()=>s("Connections").t,[s]),o=Kt(),a=je(o),l=D(),c=m.useRef(null),[i,r]=ce({uploadTotal:0,downloadTotal:0}),{visible:u,show:x,hide:y}=he();function v(){l.closeAllConnections().finally(()=>y())}const{connections:d,feed:p,save:P,toggleSave:g}=is(),b=m.useMemo(()=>d.map(f=>({id:f.id,host:`${f.metadata.host||f.metadata.destinationIP}:${f.metadata.destinationPort}`,chains:f.chains.slice().reverse().join(" / "),rule:f.rulePayload?`${f.rule} :: ${f.rulePayload}`:f.rule,time:new Date(f.start).getTime(),upload:f.upload,download:f.download,sourceIP:f.metadata.sourceIP,type:f.metadata.type,network:f.metadata.network.toUpperCase(),speed:{upload:f.uploadSpeed,download:f.downloadSpeed},completed:!!f.completed,original:f})),[d]),k=m.useMemo(()=>{const f=rt(d,C=>C.metadata.sourceIP);return Object.keys(f).map(C=>({label:C,number:f[C].length})).sort((C,h)=>C.label.localeCompare(h.label))},[d]),N=m.useRef(null),L=dt(N,{threshold:[1]}),X=m.useMemo(()=>[z.accessor(j.Host,{minSize:260,size:260,header:n(`columns.${j.Host}`)}),z.accessor(j.Network,{minSize:80,size:80,header:n(`columns.${j.Network}`)}),z.accessor(j.Type,{minSize:100,size:100,header:n(`columns.${j.Type}`)}),z.accessor(j.Chains,{minSize:200,size:200,header:n(`columns.${j.Chains}`)}),z.accessor(j.Rule,{minSize:140,size:140,header:n(`columns.${j.Rule}`)}),z.accessor(f=>[f.speed.upload,f.speed.download],{id:j.Speed,header:n(`columns.${j.Speed}`),minSize:200,size:200,sortDescFirst:!0,sortingFn(f,C){var _,O;const h=((_=f.original)==null?void 0:_.speed)??{upload:0,download:0},I=((O=C.original)==null?void 0:O.speed)??{upload:0,download:0};return h.download===I.download?h.upload-I.upload:h.download-I.download},cell:f=>ds(f.getValue()[0],f.getValue()[1])}),z.accessor(j.Upload,{minSize:100,size:100,header:n(`columns.${j.Upload}`),cell:f=>U(f.getValue())}),z.accessor(j.Download,{minSize:100,size:100,header:n(`columns.${j.Download}`),cell:f=>U(f.getValue())}),z.accessor(j.SourceIP,{minSize:140,size:140,header:n(`columns.${j.SourceIP}`),filterFn:"equals"}),z.accessor(j.Time,{minSize:120,size:120,header:n(`columns.${j.Time}`),cell:f=>Te(new Date(f.getValue()),t),sortingFn:(f,C)=>{var h,I;return(((h=C.original)==null?void 0:h.time)??0)-(((I=f.original)==null?void 0:I.time)??0)}})],[t,n]);m.useLayoutEffect(()=>{function f(C){for(const h of C)r({uploadTotal:h.uploadTotal,downloadTotal:h.downloadTotal}),p(h.connections)}return o==null||o.subscribe("data",f),()=>{o==null||o.unsubscribe("data",f)}},[o,p,r]),ut(()=>{var f;(f=a.current)==null||f.destory()});const Q=mt({data:b,columns:X,getCoreRowModel:ft(),getSortedRowModel:xt(),getFilteredRowModel:pt(),initialState:{sorting:[{id:j.Time,desc:!1}]},columnResizeMode:"onChange",enableColumnResizing:!0}),ne=Q.getHeaderGroups()[0],[fe,xe]=m.useState("");function pe(f){var C;xe(f),(C=Q.getColumn(j.SourceIP))==null||C.setFilterValue(f||void 0)}const[A,F]=ce({visible:!1,selectedID:"",connection:{}});function ge(){F(f=>{f.connection.completed=!0}),l.closeConnection(A.selectedID)}const W=je(A.connection);m.useEffect(()=>{var C;const f=(C=b.find(h=>h.id===A.selectedID))==null?void 0:C.original;f?F(h=>{h.connection={...f},A.selectedID===W.current.id&&(h.connection.completed=W.current.completed)}):Object.keys(W.current).length!==0&&!W.current.completed&&F(h=>{h.connection.completed=!0})},[b,A.selectedID,W,F]);const oe=m.useMemo(()=>((L==null?void 0:L.intersectionRatio)??0)<1,[L]),H=ne.headers.map((f,C)=>{const h=f.column,I=h.id;return e.jsxs("th",{className:w("connections-th",{resizing:h.getIsResizing(),fixed:h.id===j.Host,shadow:oe&&h.id===j.Host}),style:{width:f.getSize()},ref:h.id===j.Host?N:void 0,children:[e.jsxs("div",{onClick:h.getToggleSortingHandler(),children:[Re(f.column.columnDef.header,f.getContext()),h.getIsSorted()!==!1?h.getIsSorted()==="desc"?" ↓":" ↑":null]}),C!==ne.headers.length-1&&e.jsx("div",{onMouseDown:f.getResizeHandler(),onTouchStart:f.getResizeHandler(),className:"connections-resizer"})]},I)}),ye=Q.getRowModel().rows.map(f=>{var C;return e.jsx("tr",{className:"cursor-default select-none",onClick:()=>{var h;return F({visible:!0,selectedID:(h=f.original)==null?void 0:h.id})},children:f.getAllCells().map(h=>{var _;const I=w("connections-block",{"text-center":rs.has(h.column.id),completed:(_=f.original)==null?void 0:_.completed},{fixed:h.column.id===j.Host,shadow:oe&&h.column.id===j.Host});return e.jsx("td",{className:I,style:{width:h.column.getSize()},children:Re(h.column.columnDef.cell,h.getContext())},h.column.id)})},(C=f.original)==null?void 0:C.id)});return e.jsxs("div",{className:"page !h-100vh",children:[e.jsxs(V,{title:n("title"),children:[e.jsx("span",{className:"connections-filter flex-1 cursor-default",children:`(${n("total.text")}: ${n("total.upload")} ${U(i.uploadTotal)} ${n("total.download")} ${U(i.downloadTotal)})`}),e.jsx(tt,{className:"connections-filter",checked:P,onChange:g,children:n("keepClosed")}),e.jsx(R,{className:"connections-filter dangerous",onClick:x,type:"close-all",size:20})]}),k.length>1&&e.jsx(as,{devices:k,selected:fe,onChange:pe}),e.jsx(B,{ref:c,className:"connections-card relative",children:e.jsx("div",{className:"min-h-full min-w-full overflow-auto",children:e.jsxs("table",{children:[e.jsx("thead",{children:e.jsx("tr",{className:"connections-header",children:H})}),e.jsx("tbody",{children:ye})]})})}),e.jsx(Qe,{title:n("closeAll.title"),show:u,onClose:y,onOk:v,children:n("closeAll.content")}),e.jsxs(os,{containerRef:c,bodyClassName:"flex flex-col",visible:A.visible,"max-width":450,children:[e.jsxs("div",{className:"h-8 flex items-center justify-between",children:[e.jsx("span",{className:"pl-3 font-bold",children:n("info.title")}),e.jsx(R,{type:"close",size:16,className:"cursor-pointer",onClick:()=>F("visible",!1)})]}),e.jsx(ls,{className:"mt-3 px-5",connection:A.connection}),e.jsx("div",{className:"mt-3 flex justify-end pr-3",children:e.jsx(q,{type:"danger",disabled:A.connection.completed,onClick:()=>ge(),children:n("info.closeConnection")})})]})]})}function ms(){const{translation:s}=E(),{t}=s("Settings"),{hostname:n,port:o,secret:a}=se(),[l,c]=T(Ie),[i,r]=ce({hostname:"",port:"",secret:""});m.useEffect(()=>{r({hostname:n,port:o,secret:a})},[n,o,a,r]);const[u,x]=T(Ee),[y,v]=T(Le);function d(){const{hostname:b,port:k,secret:N}=i;x([{hostname:b,port:k,secret:N}])}function p(){const{hostname:b,port:k,secret:N}=i,L=[...u,{hostname:b,port:k,secret:N}];x(L),v(L.length-1)}function P(){const{hostname:b,port:k}=i,N=u.findIndex(X=>X.hostname===b&&X.port===k);if(N===-1){Ne(t("externalControllerSetting.deleteErrorText"));return}const L=[...u.slice(0,N),...u.slice(N+1)];x(L),y>=N&&v(0)}const g=e.jsxs("div",{className:"space-x-3",children:[e.jsx(q,{type:"primary",onClick:()=>p(),children:t("externalControllerSetting.addText")}),e.jsx(q,{type:"danger",disabled:u.length<2,onClick:()=>P(),children:t("externalControllerSetting.deleteText")})]});return e.jsxs(Qe,{className:"!w-105 !<sm:w-84",show:!l,title:t("externalControllerSetting.title"),bodyClassName:"external-controller",footerExtra:g,onClose:()=>c(!0),onOk:d,children:[e.jsx(Zt,{type:"info",inside:!0,children:e.jsx("p",{children:t("externalControllerSetting.note")})}),e.jsxs("div",{className:"flex items-center",children:[e.jsx("span",{className:"my-1 w-14 font-bold md:my-3",children:t("externalControllerSetting.host")}),e.jsx(Y,{className:"my-1 flex-1 md:my-3",align:"left",inside:!0,value:i.hostname,onChange:b=>r("hostname",b),onEnter:d})]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"my-1 w-14 font-bold md:my-3",children:t("externalControllerSetting.port")}),e.jsx(Y,{className:"my-1 w-14 flex-1 md:my-3",align:"left",inside:!0,value:i.port,onChange:b=>r("port",b),onEnter:d})]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"my-1 w-14 font-bold md:my-3",children:t("externalControllerSetting.secret")}),e.jsx(Y,{className:"my-1 w-14 flex-1 md:my-3",align:"left",inside:!0,value:i.secret,onChange:b=>r("secret",b),onEnter:d})]})]})}const hs=[{label:"Default",value:""},{label:"Debug",value:"debug"},{label:"Info",value:"info"},{label:"Warn",value:"warning"},{label:"Error",value:"error"},{label:"Silent",value:"silent"}],fs=new Map([["debug","text-teal-500"],["info","text-sky-500"],["warning","text-pink-500"],["error","text-rose-500"]]);function xs(){var v;const s=m.useRef(null),t=m.useRef([]),[n,o]=m.useState([]),{translation:a}=E(),{data:{logLevel:l},set:c}=de(),{general:{logLevel:i}}=ue(),{t:r}=a("Logs"),u=qe(),x=m.useRef(((v=s.current)==null?void 0:v.scrollHeight)??0),y=(i==null?void 0:i.toLowerCase())==="silent";return m.useLayoutEffect(()=>{const d=s.current;d!=null&&x.current===d.scrollTop+d.clientHeight&&(d.scrollTop=d.scrollHeight-d.clientHeight),x.current=(d==null?void 0:d.scrollHeight)??0}),m.useEffect(()=>{function d(p){t.current=t.current.slice().concat(p.map(P=>({...P,time:new Date}))),o(t.current)}return u!=null&&(u.subscribe("data",d),t.current=u.buffer(),o(t.current)),()=>u==null?void 0:u.unsubscribe("data",d)},[u]),e.jsxs("div",{className:"page",children:[e.jsxs(V,{title:r("title"),children:[e.jsxs("span",{className:"mr-2 text-sm text-primary-darken",children:[r("levelLabel"),":"]}),e.jsx(Ze,{disabled:y,options:hs,value:y?"silent":l,onSelect:d=>c(p=>{p.logLevel=d})})]}),e.jsx(B,{className:"mt-2.5 flex flex-1 flex-col md:mt-4",children:e.jsx("ul",{className:"logs-panel",ref:s,children:n.map((d,p)=>e.jsxs("li",{className:"inline-block text-[11px] leading-5",children:[e.jsxs("span",{className:"mr-2 text-orange-400",children:["[",le(d.time).format("YYYY-MM-DD HH:mm:ss"),"]"]}),e.jsxs("span",{className:fs.get(d.type),children:["[",d.type.toUpperCase(),"]"]}),e.jsxs("span",{children:[" ",d.payload]})]},p))})})]})}var be=(s=>(s.SPEED_NOTIFY="speed-notify",s))(be||{});class ps{constructor(){this.EE=new He}notifySpeedTest(){this.EE.emit("speed-notify")}subscribe(t,n){this.EE.addListener(t,n)}unsubscribe(t,n){this.EE.removeListener(t,n)}}const Ce=new ps;const De={"#909399":0,"#00c520":260,"#ff9a28":600,"#ff3e5e":1/0};function nt(s){var p,P;const{config:t,className:n}=s,{set:o}=me(),a=D(),l=m.useCallback(async g=>{if(Z())return await($==null?void 0:$.getProxyDelay(g))??0;const{data:{delay:b}}=await a.getProxyDelay(g);return b},[a]),c=m.useCallback(async function(){const g=await Be.fromPromise(l(t.name),k=>k),b=g.isErr()?0:g.value;o(k=>{const N=k.proxies.find(L=>L.name===t.name);N!=null&&N.history.push({time:Date.now().toString(),delay:b})})},[t.name,l,o]),i=(p=t.history)!=null&&p.length?t.history.slice(-1)[0].delay:0,r=(P=t.history)!=null&&P.length?t.history.slice(-1)[0].meanDelay:void 0,u=i===0?"-":`${i}ms`,x=r?`(${r}ms)`:"";m.useLayoutEffect(()=>{const g=()=>{c()};return Ce.subscribe(be.SPEED_NOTIFY,g),()=>Ce.unsubscribe(be.SPEED_NOTIFY,g)},[c]);const y=m.useMemo(()=>i===0,[i]),v=m.useMemo(()=>Object.keys(De).find(g=>(r||i)<=De[g]),[i,r]),d=y?"#E5E7EB":v;return e.jsxs("div",{className:w("proxy-item",{"opacity-50":y},n),children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("span",{className:w("rounded-sm py-[3px] px-1 text-[10px] text-white",{"text-gray-600":y}),style:{backgroundColor:d},children:t.type}),e.jsx("p",{className:"proxy-name",children:t.name})]}),e.jsxs("div",{className:"h-full flex flex-col items-center justify-center text-[10px] md:h-[18px] md:flex-row md:justify-between space-y-3 md:space-y-0",children:[e.jsxs("p",{children:[u,x]}),t.udp&&e.jsx("p",{className:"rounded bg-gray-200 p-[3px] text-gray-600",children:"UDP"})]})]})}function gs(s){const{markProxySelected:t}=me(),[n]=T(Gt),{data:o}=de(),a=D(),{config:l}=s;async function c(u){if(await a.changeProxySelected(s.config.name,u),t(s.config.name,u),o.breakConnections){const x=[],y=await a.getConnections();for(const v of y.data.connections)v.chains.includes(s.config.name)&&x.push(v.id);await Promise.all(x.map(v=>a.closeConnection(v)))}}const i=m.useMemo(()=>{var x,y;const u=new Set;for(const v of l.all){const d=(x=n.get(v))==null?void 0:x.history;(((y=n.get(v))==null?void 0:y.alive)===!1||d!=null&&d.length&&d.slice(-1)[0].delay===0)&&u.add(v)}return u},[l.all,n]),r=l.type==="Selector";return e.jsxs("div",{className:"proxy-group",children:[e.jsxs("div",{className:"mt-4 h-10 w-full flex items-center justify-between md:mt-0 md:h-15 md:w-auto",children:[e.jsx("span",{className:"overflow-ellipsis h-6 w-35 overflow-hidden whitespace-nowrap px-5 md:w-30",children:l.name}),e.jsx(ie,{className:"mr-5 md:mr-0",children:l.type})]}),e.jsx("div",{className:"flex-1 py-2 md:py-4",children:e.jsx(Xt,{className:"ml-5 md:ml-8",data:l.all,onClick:c,errSet:i,select:l.now,canClick:r,rowHeight:30})})]})}function ys(s){const{update:t}=Ke(),{translation:n,lang:o}=E(),a=D(),{provider:l}=s,{t:c}=n("Proxies"),{visible:i,hide:r,show:u}=he();function x(){u(),a.healthCheckProvider(l.name).then(async()=>await t()).finally(()=>r())}function y(){u(),a.updateProvider(l.name).then(async()=>await t()).finally(()=>r())}const v=m.useMemo(()=>l.proxies.slice().sort((d,p)=>-1*Pe(d,p)),[l.proxies]);return e.jsxs(B,{className:"proxy-provider",children:[e.jsx(st,{visible:i}),e.jsxs("div",{className:"flex flex-col justify-between md:flex-row md:items-center",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx("span",{className:"mr-6",children:l.name}),e.jsx(ie,{children:l.vehicleType})]}),e.jsxs("div",{className:"flex items-center pt-3 md:pt-0",children:[l.updatedAt&&e.jsx("span",{className:"text-sm",children:`${c("providerUpdateTime")}: ${Te(new Date(l.updatedAt),o)}`}),e.jsx(R,{className:"cursor-pointer pl-5 text-red",type:"healthcheck",size:18,onClick:x}),e.jsx(R,{className:"cursor-pointer pl-5",type:"update",size:18,onClick:y})]})]}),e.jsx("ul",{className:"proxies-list",children:v.map(d=>e.jsx("li",{children:e.jsx(nt,{className:"proxy-provider-item",config:d})},d.name))})]})}const vs={0:"sort",1:"sort-ascending",2:"sort-descending"};function Pe(s,t){const n=s.history.length>0?s.history.slice(-1)[0].delay:0,o=t.history.length>0?t.history.slice(-1)[0].delay:0,a=s.alive===!1?0:n;return((t.alive===!1?0:o)||Number.MAX_SAFE_INTEGER)-(a||Number.MAX_SAFE_INTEGER)}function ws(){const{groups:s,global:t}=me(),{data:n,set:o}=de(),{general:a}=ue(),{translation:l}=E(),{t:c}=l("Proxies"),i=m.useMemo(()=>a.mode==="global"?[t,...s]:s,[a,s,t]);return e.jsx(e.Fragment,{children:i.length!==0&&e.jsxs("div",{className:"flex flex-col",children:[e.jsx(V,{title:c("groupTitle"),children:e.jsx(tt,{className:"cursor-pointer text-sm text-primary-600 text-shadow-primary",checked:n.breakConnections,onChange:r=>o("breakConnections",r),children:c("breakConnectionsText")})}),e.jsx(B,{className:"my-2.5 p-0 md:my-4",children:e.jsx("ul",{className:"list-none divide-y divide-gray-300",children:i.map(r=>e.jsx("li",{children:e.jsx(gs,{config:r})},r.name))})})]})})}function js(){const{providers:s}=Ke(),{translation:t}=E(),{t:n}=t("Proxies");return e.jsx(e.Fragment,{children:s.length!==0&&e.jsxs("div",{className:"flex flex-col",children:[e.jsx(V,{title:n("providerTitle")}),e.jsx("ul",{className:"list-none",children:s.map(o=>e.jsx("li",{className:"my-2.5 md:my-4",children:e.jsx(ys,{provider:o})},o.name))})]})})}function Ns(){const{proxies:s}=me(),{translation:t}=E(),{t:n}=t("Proxies");function o(){Ce.notifySpeedTest()}const{current:a,next:l}=Qt([1,2,0]),c=m.useMemo(()=>{switch(a){case 2:return s.slice().sort((r,u)=>Pe(r,u));case 1:return s.slice().sort((r,u)=>-1*Pe(r,u));default:return s.slice()}},[a,s]),i=l;return e.jsx(e.Fragment,{children:c.length!==0&&e.jsxs("div",{className:"flex flex-col",children:[e.jsxs(V,{title:n("title"),children:[e.jsx(R,{className:"ml-3",type:vs[a],onClick:i,size:20}),e.jsx(R,{className:"ml-3",type:"speed",size:20}),e.jsx("span",{className:"proxies-speed-test",onClick:o,children:n("speedTestText")})]}),e.jsx("ul",{className:"proxies-list",children:c.map(r=>e.jsx("li",{children:e.jsx(nt,{config:r})},r.name))})]})})}function bs(){return e.jsxs("div",{className:"page",children:[e.jsx(ws,{}),e.jsx(js,{}),e.jsx(Ns,{})]})}function Cs(s){const{update:t}=We(),{translation:n,lang:o}=E(),a=D(),{provider:l}=s,{t:c}=n("Rules"),{visible:i,hide:r,show:u}=he();function x(){u(),a.updateRuleProvider(l.name).then(async()=>await t()).finally(()=>r())}const y=w("rule-provider-icon",{"rule-provider-loading":i});return e.jsx("div",{className:"rule-provider",children:e.jsxs("div",{className:"rule-provider-header",children:[e.jsxs("div",{className:"rule-provider-header-part",children:[e.jsx("span",{className:"rule-provider-name",children:l.name}),e.jsx(ie,{children:l.vehicleType}),e.jsx(ie,{className:"rule-provider-behavior",children:l.behavior}),e.jsx("span",{className:"rule-provider-update",children:`${c("ruleCount")}: ${l.ruleCount}`})]}),e.jsxs("div",{className:"rule-provider-header-part",children:[l.updatedAt&&e.jsx("span",{className:"rule-provider-update",children:`${c("providerUpdateTime")}: ${Te(new Date(l.updatedAt),o)}`}),e.jsx(R,{className:y,type:"update",size:18,onClick:x})]})]})})}function Ps(){const{providers:s}=We(),{translation:t}=E(),{t:n}=t("Rules");return e.jsx(e.Fragment,{children:s.length!==0&&e.jsxs("div",{className:"flex flex-col",children:[e.jsx(V,{title:n("providerTitle")}),e.jsx(B,{className:"mt-4 rounded p-0 shadow-primary divide-y",children:s.map(o=>e.jsx(Cs,{provider:o},o.name))})]})})}function Ss(){const{rules:s,update:t}=Wt(),{translation:n}=E(),{t:o}=n("Rules");K("rules",t);function a({index:l,style:c}){const i=s[l];return e.jsx("li",{className:"rule-item",style:c,children:e.jsxs("div",{className:"flex py-1",children:[e.jsx("div",{className:"rule-type w-40 text-center",children:i.type}),e.jsx("div",{className:"payload flex-1 text-center",children:i.payload}),e.jsx("div",{className:"rule-proxy w-40 text-center",children:i.proxy})]})})}return e.jsxs("div",{className:"page",children:[e.jsx(Ps,{}),e.jsx(V,{className:"not-first:mt-7.5",title:o("title")}),e.jsx(B,{className:"mt-2.5 flex flex-1 flex-col p-0 md:mt-4 focus:outline-none",children:e.jsx(gt,{className:"min-h-120",children:({height:l,width:c})=>e.jsx(yt,{height:l??0,width:c??0,itemCount:s.length,itemSize:50,children:a})})})]})}const ks=[{label:"中文",value:"zh_CN"},{label:"English",value:"en_US"}];function $s(){const{premium:s}=Ve(),{data:t,update:n}=Ye(),{general:o,update:a}=ue(),l=Ue(Ie),[c,i]=T(Le),r=ee(Ee),u=se(),{translation:x,setLang:y,lang:v}=E(),{t:d}=x("Settings"),p=D(),[P,g]=ce({socks5ProxyPort:7891,httpProxyPort:7890,mixedProxyPort:0});m.useEffect(()=>{g("socks5ProxyPort",(o==null?void 0:o.socksPort)??0),g("httpProxyPort",(o==null?void 0:o.port)??0),g("mixedProxyPort",(o==null?void 0:o.mixedPort)??0)},[o,g]);async function b(h){await p.updateConfig({mode:h}),await a()}async function k(h){await($==null?void 0:$.setStartAtLogin(h)),await n()}async function N(h){await($==null?void 0:$.setSystemProxy(h)),await n()}function L(h){y(h)}async function X(){await p.updateConfig({port:P.httpProxyPort}),await a()}async function Q(){await p.updateConfig({"socks-port":P.socks5ProxyPort}),await a()}async function ne(){await p.updateConfig({"mixed-port":P.mixedProxyPort}),await a()}async function fe(h){await p.updateConfig({"allow-lan":h}),await a()}async function xe(){var h,I,_;try{const O=await p.reloadConfig();O.status===204?ss(d("messages.reloadOk")):Ne(`${d("messages.reloadErr")} ${O.data}`),await a()}catch(O){let ae=`${O}`;Oe.isAxiosError(O)&&(ae=(I=(h=O.response)==null?void 0:h.data)==null?void 0:I.message,ae||(ae=(_=O.response)==null?void 0:_.data)),Ne(`${d("messages.reloadErr")} ${ae}`)}}const{hostname:pe,port:A}=u,{allowLan:F,mode:ge}=o,W=(t==null?void 0:t.startAtLogin)??!1,oe=(t==null?void 0:t.systemProxy)??!1,H=(t==null?void 0:t.isClashX)??!1,ye=m.useMemo(()=>{const h=[{label:d("values.global"),value:"global"},{label:d("values.rules"),value:"rule"},{label:d("values.direct"),value:"direct"}];return s&&h.push({label:d("values.script"),value:"script"}),h},[d,s]),f=r.map((h,I)=>({value:I,label:e.jsx("span",{className:"truncate text-right",children:h.hostname})})),C=H?e.jsx("span",{className:"text-sm text-primary-darken",children:`${pe}:${A}`}):e.jsxs(e.Fragment,{children:[e.jsx(Ze,{disabled:r.length<2&&!H,options:f,value:c,onSelect:h=>i(h)}),e.jsx("span",{className:w({"modify-btn":!H},"external-controller"),onClick:()=>!H&&l(!1),children:"编辑"})]});return e.jsxs("div",{className:"page",children:[e.jsx(V,{title:d("title")}),e.jsxs(B,{className:"settings-card",children:[e.jsxs("div",{className:"flex flex-wrap",children:[e.jsxs("div",{className:"w-full flex items-center justify-between px-8 py-3 md:w-1/2",children:[e.jsx("span",{className:"label font-bold",children:d("labels.startAtLogin")}),e.jsx(we,{disabled:!(t!=null&&t.isClashX),checked:W,onChange:k})]}),e.jsxs("div",{className:"w-full flex items-center justify-between px-8 py-3 md:w-1/2",children:[e.jsx("span",{className:"label font-bold",children:d("labels.language")}),e.jsx(Me,{options:ks,value:v,onSelect:h=>L(h)})]})]}),e.jsxs("div",{className:"flex flex-wrap",children:[e.jsxs("div",{className:"w-full flex items-center justify-between px-8 py-3 md:w-1/2",children:[e.jsx("span",{className:"label font-bold",children:d("labels.setAsSystemProxy")}),e.jsx(we,{disabled:!H,checked:oe,onChange:N})]}),e.jsxs("div",{className:"w-full flex items-center justify-between px-8 py-3 md:w-1/2",children:[e.jsx("span",{className:"label font-bold",children:d("labels.allowConnectFromLan")}),e.jsx(we,{checked:F,onChange:fe})]})]})]}),e.jsxs(B,{className:"settings-card",children:[e.jsxs("div",{className:"flex flex-wrap",children:[e.jsxs("div",{className:"w-full flex items-center justify-between px-8 py-3 md:w-1/2",children:[e.jsx("span",{className:"label font-bold",children:d("labels.proxyMode")}),e.jsx(Me,{options:ye,value:ge,onSelect:b})]}),e.jsxs("div",{className:"w-full flex items-center justify-between px-8 py-3 md:w-1/2",children:[e.jsx("span",{className:"label font-bold",children:d("labels.socks5ProxyPort")}),e.jsx(Y,{className:"w-28",disabled:H,value:P.socks5ProxyPort,onChange:h=>g("socks5ProxyPort",+h),onBlur:Q})]})]}),e.jsxs("div",{className:"flex flex-wrap",children:[e.jsxs("div",{className:"w-full flex items-center justify-between px-8 py-3 md:w-1/2",children:[e.jsx("span",{className:"label font-bold",children:d("labels.httpProxyPort")}),e.jsx(Y,{className:"w-28",disabled:H,value:P.httpProxyPort,onChange:h=>g("httpProxyPort",+h),onBlur:X})]}),e.jsxs("div",{className:"w-full flex items-center justify-between px-8 py-3 md:w-1/2",children:[e.jsx("span",{className:"label font-bold",children:d("labels.mixedProxyPort")}),e.jsx(Y,{className:"w-28",disabled:H,value:P.mixedProxyPort,onChange:h=>g("mixedProxyPort",+h),onBlur:ne})]})]}),e.jsxs("div",{className:"flex flex-wrap",children:[e.jsxs("div",{className:"w-full flex items-center justify-between px-8 py-3 md:w-1/2",children:[e.jsx("span",{className:"label font-bold",children:d("labels.externalController")}),e.jsx("div",{className:"flex items-center space-x-2",children:C})]}),e.jsx("div",{className:"w-full flex md:w-1/2 items-center justify-between px-8 py-3",children:e.jsx(q,{onClick:xe,children:d("labels.reloadConfig")})})]})]})]})}const Es=""+new URL("logo-b453e72f.png",import.meta.url).href;function Ls(s){const{routes:t}=s,{translation:n}=E(),{version:o,premium:a}=Ve(),{data:l}=Ye(),{t:c}=n("SideBar"),i=ke(),r=t.map(({path:u,name:x,noMobile:y})=>e.jsx("li",{className:w("item",{"no-mobile":y}),children:e.jsx(vt,{to:{pathname:u,search:i.search},className:({isActive:v})=>w({active:v}),children:c(x)})},x));return e.jsxs("div",{className:"sidebar",children:[e.jsx("img",{src:Es,alt:"logo",className:"sidebar-logo"}),e.jsx("ul",{className:"sidebar-menu",children:r}),e.jsxs("div",{className:"sidebar-version",children:[e.jsxs("span",{className:"sidebar-version-label",children:["Clash",(l==null?void 0:l.isClashX)&&"X"," ",c("Version")]}),e.jsx("span",{className:"sidebar-version-text",children:o}),a&&e.jsx("span",{className:"sidebar-version-label",children:"Premium"})]})]})}function Is(){qe();const s=ke(),t=[{path:"/proxies",name:"Proxies",element:e.jsx(bs,{})},{path:"/logs",name:"Logs",element:e.jsx(xs,{})},{path:"/rules",name:"Rules",element:e.jsx(Ss,{}),noMobile:!0},{path:"/connections",name:"Connections",element:e.jsx(us,{})},{path:"/settings",name:"Settings",element:e.jsx($s,{})}],n=e.jsxs("div",{className:w("app",{"not-clashx":!Z()}),children:[e.jsx(Ls,{routes:t}),e.jsx("div",{className:"page-container",children:e.jsx(wt,{})}),e.jsx(ms,{})]});return e.jsx(jt,{children:e.jsxs(ve,{path:"/",element:n,children:[e.jsx(ve,{path:"/",element:e.jsx(Nt,{to:{pathname:"/proxies",search:s.search},replace:!0})}),t.map(o=>e.jsx(ve,{path:o.path,element:o.element},o.path))]})})}function Ae(){const s=document.getElementById("root"),t=e.jsx(m.StrictMode,{children:e.jsx(Ct,{children:e.jsx(m.Suspense,{fallback:e.jsx(st,{visible:!0}),children:e.jsx(Is,{})})})});bt(s).render(t)}Z()?St(()=>Ae()):Ae();
